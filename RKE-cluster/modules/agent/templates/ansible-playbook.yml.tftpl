---
- name: Configure RKE2 Agent Nodes
  hosts: localhost
  become: true
  gather_facts: true
  vars:
    cluster_name: "${cluster_name}"
    docker_version: "${docker_version}"
    rke_version: "${rke_version}"
    region: "${aws_region}"
    server_endpoint: "${server_endpoint}"

  tasks:
    - name: Update apt cache and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist

    - name: Install prerequisites
      apt:
        name:
          - curl
          - wget
          - jq
          - python3
          - python3-pip
          - python3-venv
          - awscli
        state: present
        update_cache: yes

    - name: Install RKE2 agent
      shell: |
        curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE=agent sh -
      args:
        creates: /usr/local/bin/rke2

    - name: Install Docker Compose
      get_url:
        url: "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-{{ ansible_system | lower }}-{{ ansible_architecture }}"
        dest: /usr/local/bin/docker-compose
        mode: '0755'

    - name: Configure system limits
      lineinfile:
        path: /etc/security/limits.conf
        line: "{{ item }}"
        state: present
      loop:
        - "* soft nofile 65536"
        - "* hard nofile 65536"
        - "* soft nproc 32768"
        - "* hard nproc 32768"

    - name: Configure sysctl parameters
      copy:
        dest: /etc/sysctl.d/99-kubernetes-cri.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.ipv4.ip_forward                 = 1
          net.bridge.bridge-nf-call-ip6tables = 1

    - name: Apply sysctl parameters
      command: sysctl --system
      changed_when: false

    - name: Disable swap
      command: swapoff -a
      changed_when: false

    - name: Remove swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: Ensure RKE2 config directory exists
      file:
        path: /etc/rancher/rke2
        state: directory
        mode: '0755'

    - name: Fetch RKE2 token from Secrets Manager via boto3 (no awscli)
      shell: |
        python3 - <<'PY'
        import boto3
        import sys
        client = boto3.client('secretsmanager', region_name='{{ region }}')
        print(client.get_secret_value(SecretId='{{ cluster_name }}-rke2-token')['SecretString'])
        PY
      register: rke2_token
      changed_when: false

    - name: Write RKE2 agent config
      copy:
        dest: /etc/rancher/rke2/config.yaml
        content: |
          token: {{ rke2_token.stdout | trim }}
          server: https://ip-{{ server_endpoint | replace('.', '-') }}.{{ region }}.compute.internal:9345
          cloud-provider-name: "aws"
        mode: '0644'

    - name: Enable and start rke2-agent
      systemd:
        name: rke2-agent
        enabled: yes
        state: started
        daemon_reload: yes

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes 