#!/bin/bash
# RKE Cluster Initialization Script
# This script initializes the RKE cluster on the first server node

set -e

CLUSTER_NAME="dev"
CONFIG_FILE="/opt/rke/cluster.yml"
KUBECONFIG_FILE="/opt/rke/kube_config_cluster.yml"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# Function to check if cluster is already initialized
check_cluster_status() {
    if [ -f "$KUBECONFIG_FILE" ]; then
        log "Cluster configuration file exists, checking status..."
        if /usr/local/bin/rke cluster-info --config "$CONFIG_FILE" >/dev/null 2>&1; then
            log "Cluster is already running"
            return 0
        else
            log "Cluster configuration exists but not running, will reinitialize"
            return 1
        fi
    fi
    return 1
}

# Function to initialize the cluster
init_cluster() {
    log "Initializing RKE cluster: $CLUSTER_NAME"
    
    # Validate configuration
    log "Validating cluster configuration..."
    /usr/local/bin/rke config --config "$CONFIG_FILE"
    
    if [ $? -ne 0 ]; then
        log "ERROR: Invalid cluster configuration"
        exit 1
    fi
    
    # Initialize the cluster
    log "Starting cluster initialization..."
    /usr/local/bin/rke up --config "$CONFIG_FILE"
    
    if [ $? -eq 0 ]; then
        log "Cluster initialized successfully"
        
        # Set proper permissions on kubeconfig
        chmod 600 "$KUBECONFIG_FILE"
        
        # Create symbolic link for easy access
        ln -sf "$KUBECONFIG_FILE" /home/ubuntu/.kube/config
        
        # Generate join token for agent nodes
        log "Generating join token for agent nodes..."
        /usr/local/bin/rke token create --config "$CONFIG_FILE" > /opt/rke/join-token 2>/dev/null || true
        
        log "Cluster initialization completed successfully"
        log "Kubeconfig available at: $KUBECONFIG_FILE"
        log "Join token available at: /opt/rke/join-token"
        
        # Display cluster info
        log "Cluster information:"
        /usr/local/bin/rke cluster-info --config "$CONFIG_FILE" || true
        
    else
        log "ERROR: Failed to initialize cluster"
        exit 1
    fi
}

# Function to check cluster health
check_cluster_health() {
    log "Checking cluster health..."
    
    # Wait for cluster to be ready
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if /usr/local/bin/rke cluster-info --config "$CONFIG_FILE" >/dev/null 2>&1; then
            log "Cluster is healthy and ready"
            return 0
        fi
        
        log "Waiting for cluster to be ready... (attempt $attempt/$max_attempts)"
        sleep 10
        attempt=$((attempt + 1))
    done
    
    log "WARNING: Cluster health check timed out"
    return 1
}

# Main execution
main() {
    log "Starting RKE cluster initialization process"
    
    # Check if cluster is already initialized
    if check_cluster_status; then
        log "Cluster is already initialized and running"
        exit 0
    fi
    
    # Initialize the cluster
    init_cluster
    
    # Check cluster health
    check_cluster_health
    
    log "RKE cluster initialization process completed"
}

# Run main function
main "$@" 