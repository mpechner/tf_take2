#!/bin/bash
# RKE Agent Cluster Join Script
# This script is used to join agent nodes to the RKE cluster

set -e

CLUSTER_NAME="dev"
NODE_NAME="agent-node"
NODE_IP="{{ ansible_default_ipv4.address }}"

# Function to log messages
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# Function to check if node is already part of the cluster
check_cluster_membership() {
    if [ -f "/opt/rke/.cluster_joined" ]; then
        log "Node is already part of the cluster"
        return 0
    fi
    return 1
}

# Function to join the cluster
join_cluster() {
    log "Joining node $NODE_NAME to cluster $CLUSTER_NAME"
    
    # Create join token file (this would be provided by the cluster master)
    if [ ! -f "/opt/rke/join-token" ]; then
        log "ERROR: Join token not found. Please obtain the join token from the cluster master."
        exit 1
    fi
    
    # Execute the join command
    /usr/local/bin/rke agent join \
        --config /opt/rke/rke-agent-config.yml \
        --token-file /opt/rke/join-token \
        --node-name "$NODE_NAME" \
        --node-ip "$NODE_IP"
    
    if [ $? -eq 0 ]; then
        log "Successfully joined cluster"
        touch /opt/rke/.cluster_joined
    else
        log "ERROR: Failed to join cluster"
        exit 1
    fi
}

# Function to start the agent service
start_agent_service() {
    log "Starting RKE agent service"
    systemctl start rke-agent
    systemctl enable rke-agent
    
    if systemctl is-active --quiet rke-agent; then
        log "RKE agent service started successfully"
    else
        log "ERROR: Failed to start RKE agent service"
        exit 1
    fi
}

# Main execution
main() {
    log "Starting RKE agent cluster join process"
    
    # Check if already part of cluster
    if check_cluster_membership; then
        log "Node is already part of the cluster, starting agent service"
        start_agent_service
        exit 0
    fi
    
    # Join the cluster
    join_cluster
    
    # Start the agent service
    start_agent_service
    
    log "RKE agent cluster join process completed successfully"
}

# Run main function
main "$@" 